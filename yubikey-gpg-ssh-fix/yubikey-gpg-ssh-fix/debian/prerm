#!/bin/bash
set -e

ETC_DIR="/etc/yubikey-gpg-ssh-fix"
BACKUP_DIR="${ETC_DIR}/backup"

case "$1" in
    remove|upgrade|deconfigure)

        # remove git ppa
        add-apt-repository -ry ppa:git-core/ppa

        # check if backup directory exists
        if [ ! -d "${BACKUP_DIR}" ]
        then
            exit 1
        fi

        # try to restore backuped files for every user
        for D in `find "${BACKUP_DIR}/" -type d`
        do
            # extract user names from folder names
            USER=`echo "${D}" | rev | cut -d "/" -f1 | rev`
            echo "restoring backuped files for ${USER}"

            # restore gpg.conf
            if [ -e "${D}/gpg.conf" ]
            then
                # make sure .gnupg exists
                if [ ! -d "/home/${USER}/.gnupg/" ]
                then
                    su -c 'mkdir -p "/home/${USER}/.gnupg/"' "${USER}"
                    # TODO: delete chown -R "${USER}:${USER}" "/home/${USER}/.gnupg/"
                fi

                # move backuped file back
                su -c 'mv "${D}/gpg.conf" "/home/${USER}/.gnupg/gpg.conf"' "${USER}"
                # TODO: delete chown "${USER}:${USER}" "/home/${USER}/.gnupg/gpg.conf"
                chmod 600 "/home/${USER}/.gnupg/gpg.conf"
            fi

            # restore gnome-keyring-gpg.desktop
            if [ -e "${D}/gnome-keyring-gpg.desktop" ]
            then
                # make sure targed directory exists
                if [ ! -d "/home/${USER}/.config/autostart" ]
                then
                    su -c 'mkdir -p "/home/${USER}/.config/autostart"' "${USER}"
                    # TODO: delete chown -R "${USER}:${USER}" "/home/${USER}/.gnupg/"
                fi

                # move backuped file back
                su -c 'mv "${D}/gnome-keyring-gpg.desktop" \
                    "/home/${USER}/.config/autostart/gnome-keyring-gpg.desktop"' \
                    "${USER}"
                # TODO: delete chown "${USER}:${USER}" "/home/${USER}/.gnupg/gpg.conf"
                chmod 600 "/home/${USER}/.config/autostart/gnome-keyring-gpg.desktop"
            fi

            # delete folder, so autoremove doesn't complain
            rm -rf "${D}"

        done
    ;;

    failed-upgrade)
    ;;

    *)
        echo "prerm called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
