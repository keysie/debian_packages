#!/bin/bash
set -e

ETC_DIR="/etc/yubikey-gpg-ssh-fix"
BACKUP_DIR="${ETC_DIR}/backup"

case "$1" in
    remove|upgrade|deconfigure)
    
        # check if backup directory exists
        if [ ! -d "${BACKUP_DIR}" ]
        then
            exit 1
        fi
        
        # try to restore backuped gpg.conf for every user
        for D in `find "${BACKUP_DIR}/" -type d`
        do
            if [ -e "${D}/gpg.conf" ]
            then
                # extract user names from folder names
                echo "${D}"
                USER=`echo "${D}" | rev | cut -d "/" -f1 | rev`
                echo "${USER}"
                
                # make sure .gnupg exists
                if [ ! -d "/home/${USER}/.gnupg/" ]
                then
                    mkdir -p "/home/${USER}/.gnupg/"
                    chown -R "${USER}:${USER}" "/home/${USER}/.gnupg/"
                fi
                
                # move backuped file back
                mv "${D}/gpg.conf" "/home/${USER}/.gnupg/gpg.conf"
                chown "${USER}:${USER}" "/home/${USER}/.gnupg/gpg.conf"
                chmod 600 "/home/${USER}/.gnupg/gpg.conf"
                
                # delete folder, so autoremove doesn't complain
                rm -rf "${D}"
            fi
        done
    ;;

    failed-upgrade)
    ;;

    *)
        echo "prerm called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
