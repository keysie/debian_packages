#!/bin/bash
set -e

ETC_DIR="/etc/yubikey-gpg-ssh-fix"
HOME_DIR="/home/${SUDO_USER}"
BACKUP_DIR="${ETC_DIR}/backup/${SUDO_USER}"

case "$1" in
    configure)
    
        # create backup folder for user
        mkdir -p "${BACKUP_DIR}"
        
        # backup existing gpg.conf (if any)
        if [ -e "${HOME_DIR}/.gnupg/gpg.conf" ]
        then
            mv "${HOME_DIR}/.gnupg/gpg.conf" "${BACKUP_DIR}/gpg.conf"
        else
            su -c mkdir -p "${HOME_DIR}/.gnupg/" "${SUDO_USER}"
        fi
        
        # install new gpg.conf
        if [ -e "${ETC_DIR}/gpg.conf" ]
        then
            cp "${ETC_DIR}/gpg.conf" "${HOME_DIR}/.gnupg/"
            chown "${SUDO_USER}:${SUDO_USER}" "${HOME_DIR}/.gnupg/gpg.conf"
            chmod 600 "/home/${SUDO_USER}/.gnupg/gpg.conf"
        else
            echo "postinst couldn't find gpg.conf"
            exit 1
        fi
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
